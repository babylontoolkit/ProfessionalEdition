<!DOCTYPE html>
<html lang="en">
<head>
    <title>###TITLE###</title>
    <!-- Policy -->
    <meta http-equiv="Content-Security-Policy" content="default-src * ws: wss: gap: data: file: http: https: blob:; style-src * 'unsafe-inline' ws: wss: gap: data: file: http: https: blob:; script-src * 'unsafe-inline'###EVAL### ws: wss: gap: data: file: http: https: blob:" />
    <!-- Caches -->
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html" charset="utf-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <!-- Default -->
    <meta name="edge" content="IE=edge" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, shrink-to-fit=no, user-scalable=no, viewport-fit=cover">
    <meta name="browsermode" content="application">
    <meta name="description" content="###TITLE###">
    <meta name="theme-color" content="###SPLASH###">
    <!-- Apple -->
    <meta name="apple-mobile-web-app-title" content="###SHORT###">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <!-- Android  -->
    <meta name="mobile-web-app-capable" content="yes">
    <!-- Windows  -->
    <meta name="application-name" content="###TITLE###">
    <meta name="msapplication-navbutton-color" content="###SPLASH###">
    <meta name="msapplication-tooltip" content="###TITLE###">
    <meta name="msapplication-starturl" content="###START###">
    <meta name="msapplication-TileColor" content="###SPLASH###">
    <meta name="msapplication-tap-highlight" content="no">
    <!-- Favorite -->
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico" />
    <!-- Toaster - https://github.com/dolce/iziToast -->
    <link href="css/toaster.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" type="text/css" href="style.css" nonce="###HASH###">
    <link rel="stylesheet" type="text/css" href="splash.css" nonce="###HASH###">
    <link rel="stylesheet" type="text/css" href="custom.css" nonce="###HASH###">
    ###NETWORK###
</head>
<body touch-action="none">
    <!-- ******************************** -->
    <!-- CUSTOM: Loader for this template -->
    <!-- ******************************** -->
    <div id="splash">
        <div id="panel">
            <center>
                <div id="proj" style="visibility:###SHOWTITLE###;">###TITLE###</div>
                <div id="load" class="load"></div>
                <img id="logo" src="###LOGO###"></img>
                <div id="details"></div>
                <div id="status"></div>
            </center>
        </div>
    </div>
    <!-- ******************************** -->
    <!-- CANVAS: Markup for this template -->
    <!-- ******************************** -->
    <div id="root">
        <canvas id="cvs"></canvas>
    </div>
    <!-- ******************************** -->
    <!-- CANVAS: Markup for this template -->
    <!-- ******************************** -->
    <div id="warning">
        <div id="portrait-warning">
            <p>Please rotate your device to portrait mode</p>
        </div>
        <div id="landscape-warning">
            <p>Please rotate your device to landscape mode</p>
        </div>
        <div id="standalone-warning">
            <p>Please use add to home screen launch icon</p>
        </div>
    </div>
    <!-- ******************************** -->
    <!-- SCRIPT: Markup for this template -->
    <!-- ******************************** -->
    <script type="text/javascript" src="###SCRIPT###/tweenjs.min.js"></script>
    <script type="text/javascript" src="###SCRIPT###/fastclick.js"></script>
    <script type="text/javascript" src="###SCRIPT###/toaster.js"></script>
    <script type="text/javascript" src="###SCRIPT###/meter.js"></script>
    <script type="text/javascript" src="###SCRIPT###/pep.js"></script>

    <!-- Engine Libraries -->
    <script type="text/javascript" src="###SCRIPT###/babylon.###MINMAX###.js"></script>
    <script type="text/javascript" src="###SCRIPT###/babylon.materials.min.js"></script>
    <script type="text/javascript" src="###SCRIPT###/babylon.gui.min.js"></script>
    <script type="text/javascript" src="###SCRIPT###/babylon.gltf.min.js"></script>

    ###ADDONS###

    <script type="text/javascript" src="###SCRIPT###/babylon.earcut.js"></script>
    <script type="text/javascript" src="###SCRIPT###/babylon.toolkit.js"></script>

    <!-- Project Script Bundle -->
    <script type="text/javascript" src="###PATH###/###BUNDLE###" id="###BUNDLE###"></script>

    <!-- Default Scene Loader -->
    <script type="text/javascript" nonce="###HASH###">
    window["BJS"] = "engine.html";
    ///////////////////////////////////////////////////////////
    // Babylon Smooth Tween Mode
    ///////////////////////////////////////////////////////////
    createjs.Ticker.timingMode = createjs.Ticker.RAF;
    ///////////////////////////////////////////////////////////
    // Babylon Query String Hooks
    ///////////////////////////////////////////////////////////
    window.getUrlParameter = (name) => {
        if (window.location == null || window.location.search == null || window.location.search === "") return null;
        name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
        var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
        var results = regex.exec(window.location.search);
        return (results !== null) ? decodeURIComponent(results[1].replace(/\+/g, ' ')) : null;
    };
    ///////////////////////////////////////////////////////////
    // Window Mobile Devcies
    ///////////////////////////////////////////////////////////
    window.isMobileDevice = () => {
        let result = false;
        if (navigator != null && navigator.userAgent != null) {
        const n = navigator.userAgent;
        if (n.match(/Android/i) || n.match(/webOS/i) || n.match(/iPhone|iPad|iPod/i) || n.match(/BlackBerry/i) || n.match(/Opera Mini/i) || n.match(/Windows Phone/i)) {
            result = true;
        }
        }
        return result;
    };
    ///////////////////////////////////////////////////////////
    // Babylon Service Worker Hooks
    ///////////////////////////////////////////////////////////
    window.versionStamp = '###VERSION###';
    window.autoStartLoader = false;
    window.useServiceWorker = false;###WORK###
    window.onServiceWorker = () => {
        if (window.autoStartLoader === true) {
            window.startSceneLoader();
        }
    };
    window.updateAvailable = () => {
        var msg = "A new version is available";
        console.warn(msg);
        iziToast.show({
            title: "UPDATE:",
            message: msg,
            timeout: 30000,
            buttons: [['<button>Reload</button>', (instance, toast) => { window.location.reload(true); }, true]]
        });    
    };
    ///////////////////////////////////////////////////////////
    window.ktx2 = ###KTX2###;
    window.scene = null;
    window.toolkit = true;
    window.progressive = ###PROGRESSIVE###;
    window.appDisplayMode = ###APPDISPLAYMODE###;
    window.appLandingPage = ###APPLANDINGPAGE###;
    window.addToHomeScreen = ###ADDTOHOMESCREEN###;
    window.lockOrientation = ###LOCKORIENTATION###;
    window.defaultOrientation = ###DEFAULTORIENTATION###;
    var engine = null;
    var pagetype = "###TYPE###", defaultScene = "###SCENE###",  autohide = ###AUTOHIDE###, percent = ###PERCENT###, offline = ###OFFLINE###, validategltf = ###VALIDATEGLTF###, handlecontext = ###CONTEXTLOST###, physics = ###AMMO###, navmesh = ###RECAST###, capsule = ###CAPSULE###, renderengine = ###RENDERENGINE###, renderinbackground = ###RENDERINBACKGROUND###, pausewhenminimized = ###PAUSEWHENMINIMIZED###, antialias = ###ANTIALIAS###, adaptive = ###ADAPTIVE###, endpoint = "###ENDPOINT###", datax = "###DATA###", folder = "###PATH###/", title = "###TITLE###";
    var stencil = ###STENCIL###, preserve = ###PRESERVE###;
    var showdetails = ###SHOWDETAILS###, showlabel = ###SHOWLABEL###;
    var gzipcontent = "###GZIP###";
    var loaded = false, paused = false, reloader = false, downloaded = 0, edownloaded = 0;
    var kilobyte = 1024, megabyte = (kilobyte * kilobyte);
    var divcvs = document.getElementById("cvs");
    var splash = document.getElementById("splash");
    var panel = document.getElementById("panel");
    var proj = document.getElementById("proj");
    var loader = document.getElementById("load");
    var label = document.getElementById("status");
    var details = document.getElementById("details");
    // ************************************************************************ //
    // QUERY STRING - Parse Root Urls And Scene Name Parameters                 //
    // ************************************************************************ //
    var rooturl = "" + (window.getUrlParameter("root") || "");
    if (rooturl != null && rooturl !== "" && !rooturl.endsWith("/")) rooturl += "/";
    var sceneurl = "" + (window.getUrlParameter("path") || folder);
    if (sceneurl != null && sceneurl !== "" && !sceneurl.endsWith("/")) sceneurl += "/";
    var scenename = "" + (window.getUrlParameter("scene") || defaultScene);
    var scenepath = "" + (rooturl + sceneurl);
    var adaptparam = window.getUrlParameter("adaptive");
    if (adaptparam != null && adaptparam !== "") {
        adaptparam = adaptparam.toLowerCase();
        adaptive = (adaptparam === "true" || adaptparam === "yes");
    }
    var renderquality = window.getUrlParameter("quality") || "0";
    if (renderquality != null) TOOLKIT.SceneManager.SetRenderQuality(parseFloat(renderquality));
    // ************************************************************************ //
    // SCENE NAME - Validate Scene Name Parameter                               //
    // ************************************************************************ //
    if (scenename == null || scenename === "") {
        if (details != null) details.innerHTML = "Version: ###BUILD###";
        if (label != null) label.innerHTML = "";
        if (load != null) load.style.animation = "none";
    }
    // ************************************************************************ //
    // STATS PANEL - Setup Performance Stats Information Panel                  //
    // ************************************************************************ //
    var showStatsPanel = ###STATS###;
    if (showStatsPanel === true && typeof FPSMeter !== "undefined") {
        var anchor = ###ANCHOR###;
        var stats = '###MODE###';
        var look = '###THEME###';
        var atop = 'auto';
        var aleft = 'auto';
        var aright = 'auto';
        var abottom = 'auto';
        if (anchor === 0) {
            atop = '5px';
            aleft = '5px';
        } else if (anchor === 1) {
            atop = '5px';
            aright = '5px';
        } else if (anchor === 2) {
            abottom = '5px';
            aleft = '5px';
        } else if (anchor === 3) {
            abottom = '5px';
            aright = '5px';
        } else {
            atop = '5px';
            aright = '5px';
        }
        window.METER = new FPSMeter({
            interval:  100,         // Update interval in milliseconds.
            smoothing: 10,          // Spike smoothing strength. 1 means no smoothing.
            show:      stats,       // Whether to show 'fps', or 'ms' = frame duration in milliseconds.
            toggleOn:  'click',     // Toggle between show 'fps' and 'ms' on this event.
            decimals:  0,           // Number of decimals in FPS number. 1 = 59.9, 2 = 59.94, ...
            maxFps:    60,          // Max expected FPS value.
            threshold: 100,         // Minimal tick reporting interval in milliseconds.
            // ..
            // Position Options
            // ..
            position: 'absolute',   // Meter position.
            zIndex:   10,           // Meter Z index.
            top:      atop,         // Meter top offset.
            left:     aleft,        // Meter left offset.
            right:    aright,       // Meter right offset.
            bottom:   abottom,      // Meter bottom offset.
            margin:   '0 0 0 0',    // Meter margin. Helps with centering the counter when left: 50%;
            // ..
            // Theme Options
            // ..
            theme: look,            // Meter theme. Build in: 'dark', 'light', 'transparent', 'colorful'.
            heat:  1,               // Allow themes to use coloring by FPS heat. 0 FPS = red, maxFps = green.
            // ..
            // Graph Options
            // ..
            graph:   1,             // Whether to show history graph.
            history: 20             // How many history states to show in a graph.
        });
    }
    // ************************************************************************ //
    // LOADING SCREEN - Attach Project Loadeing Screen Event Handler            //
    // ************************************************************************ //
    function LoadingScreen() {};
    LoadingScreen.prototype.displayLoadingUI = function() {};
    LoadingScreen.prototype.hideLoadingUI = function() {};
    // ************************************************************************ //
    // GLTF LOADER - General Page Loading Funcitons                             //
    // ************************************************************************ //
    TOOLKIT.SceneManager.ServerEndPoint = endpoint;
    TOOLKIT.SceneManager.SupportSRGBBuffers = false;
    TOOLKIT.SceneManager.PhysicsCapsuleShape = capsule;
    BABYLON.SceneLoader.OnPluginActivatedObservable.addOnce((loader) => {
        loader.validate = validategltf;
    });
    // ************************************************************************ //
    // PAGE UTILTITIES - General Page Utility Funcitons                         //
    // ************************************************************************ //
    window.updateStatus = (status, info, state) => {
        if (showlabel) {
            if (label != null && status != null && label.innerHTML !== status) {
                label.innerHTML = status.toUpperCase();
            }
        }
        if (showdetails) {
            if (details != null && info != null && details.innerHTML !== info) {
                details.innerHTML = info.toUpperCase();
            }
        }
    };
    window.updateDetails = (info, state) => {
        if (showdetails) {
            if (details != null && info != null && details.innerHTML !== info) {
                details.innerHTML = info.toUpperCase();
            }
        }
    };
    window.updateProgress = (status, state) => {
        if (showlabel) {
            if (label != null && status != null && label.innerHTML !== status) {
                label.innerHTML = status.toUpperCase();
            }
        }
    };
    window.showSceneLoader = () => {
        if (splash != null) splash.className = "";
        //if (panel != null) panel.className = "";
        //if (proj != null) proj.className = "";
        //if (label != null) label.className = "";
        //if (details != null) details.className = "";
        if (loader != null) loader.className = "data";
        // ..
        divcvs.style.opacity = "0";
        // DEPRECIATED: engine.clear(new BABYLON.Color3(0, 0, 0), true, true, true);
        engine.displayLoadingUI();
        window.updateStatus("", "", 0);
    };
    window.hideSceneLoader = () => {
        if (splash != null) splash.className = "hidden";
        //if (panel != null) panel.className = "hidden";
        //if (proj != null) proj.className = "hidden";
        //if (label != null) label.className = "hidden";
        //if (details != null) details.className = "hidden";
        if (loader != null) loader.className = "hidden";
        // ..
        var standalone_warning = document.getElementById("standalone-warning");
        if (standalone_warning != null) standalone_warning.style.display = "none";
        // ..
        engine.hideLoadingUI();
        divcvs.style.opacity = "1";
        window.updateStatus("", "", 0);
        if (TOOLKIT.SceneManager.OnLoadCompleteObservable.hasObservers() === true) {
            TOOLKIT.SceneManager.OnLoadCompleteObservable.notifyObservers(engine);
        }
        // ..
        // Support Top Window Scene Loaders (Note: Post Async Window Message)
        // ..
        if (window.parent != null && window !== window.parent) {
            window.top.postMessage({source:"eventbus", message:"hidesceneloader", data:"window"}, "*");
        }
        // ..
        // Focus Canvas Element After Scene Load (FocusRenderCanvas)
        // ..
        divcvs.focus();
    };
    window.showErrorMessage = (message, title, timeout) => {
        console.error(message);
        iziToast.error({
            message: message,
            title: title || "Error",
            timeout: timeout || 0
        });    
    };
    window.handleLoadProgress = (evt) => {
        var defaultDetails = "LOADING";
        var pstatus = "PLEASE WAIT";
        var details = defaultDetails;
        var lstate = (TOOLKIT.Utilities != null) ? TOOLKIT.Utilities.GetLoadingState() : 0;
        switch (lstate) {
            case 0:     // LOAD SCENE CONTENT
                //pstatus = "Loading";
                //details = defaultDetails;
                break;
            case 1:     // PARSE NODE TRANSFORMS
                //pstatus = "Loading";
                //details = defaultDetails;
                break;
            case 2:     // PARSE SCENE METADATA
                //pstatus = "Parsing";
                //details = "Parsing scene content";
                break;
            case 3:     // START ASSET PRELOADER
                //pstatus = "Preload";
                //details = "Preload scene content";
                break;
            case 4:     // PREPARE SCENE CONTENT
                //pstatus = "Ready";
                //details = "Preparing scene content";
                break;
        }
        if (evt.loaded > 0) {
            //var loadedPercent = "";
            //if (evt.lengthComputable) {
            //    loadedPercent = (evt.loaded * 100 / evt.total).toFixed() + "%";
            //} else {
            //    var dlCount = evt.loaded / (1024 * 1024);
            //    loadedPercent = (Math.floor(dlCount * 100.0) / 100.0).toFixed() + "MB";
            //}
            //console.log("Progress: " + loadedPercent);
            if (percent === true && evt.lengthComputable) {
                var percentage = (evt.loaded * 100 / evt.total).toFixed();
                //var percentstatus = (lstate >= 2) ? pstatus : (percentage + "%");
                var percentstatus = (percentage + "%");
                window.updateStatus(percentstatus, details, lstate);
                // DEPRECIATED: var percentstatus = (lstate >= 2) ? "" : (" " + percentage + "%");
                // DEPRECIATED: window.updateStatus(pstatus, (details + percentstatus), lstate);
            } else {
                var units = " MB";
                var dlCount = evt.loaded / megabyte;
                var progress = Math.ceil(dlCount * 100.0) / 100.0;
                if (progress > 0) {
                    if (progress >= downloaded) {
                        downloaded = progress;
                    }
                    if (downloaded > 0) {
                        if (downloaded > kilobyte) {
                            units = " GB";
                            downloaded = (downloaded / kilobyte);
                        }
                        //var sizestatus = (lstate >= 2) ? pstatus : ("" + downloaded.toFixed()) + units;
                        var sizestatus = ("" + downloaded.toFixed()) + units;
                        window.updateStatus(sizestatus, details, lstate);
                        // DEPRECIATED: var sizestatus = (lstate >= 2) ? "" : (" " + downloaded.toFixed() + units);
                        // DEPRECIATED: window.updateStatus(pstatus, (details + sizestatus), lstate);
                    }
                }
            }
        } else {
            window.updateStatus(pstatus, details, lstate);
        }
    };
    window.handleExtraProgress = (evt) => {
        var lstate = (TOOLKIT.Utilities != null) ? TOOLKIT.Utilities.GetLoadingState() : 0;
        if (evt.loaded > 0) {
            if (percent === true && evt.lengthComputable) {
                var percentage = (evt.loaded * 100 / evt.total).toFixed();
                var percentstatus = (percentage + "%");
                window.updateProgress(percentstatus, lstate);
            } else {
                var units = " MB";
                var dlCount = evt.loaded / megabyte;
                var progress = Math.ceil(dlCount * 100.0) / 100.0;
                if (progress > 0) {
                    if (progress >= edownloaded) {
                        edownloaded = progress;
                    }
                    if (edownloaded > 0) {
                        if (edownloaded > kilobyte) {
                            units = " GB";
                            edownloaded = (edownloaded / kilobyte);
                        }
                        var tdownloaded = (downloaded + edownloaded);
                        var sizestatus = ("" + tdownloaded.toFixed()) + units;
                        window.updateProgress(sizestatus, lstate);
                    }
                }
            }
        }
    };
    TOOLKIT.SceneManager.OnAssetManagerProgress = (evt) => {
        window.handleExtraProgress(evt);
    };
    // ************************************************************************ //
    // SCENE LOADER - Execute Scene Loading With Progress Information           //
    // ************************************************************************ //
    window.executeSceneLoader = (root, name) => {
        window.updateStatus("PLEASE WAIT", "LOADING", 0);
        var qlevel = TOOLKIT.SceneManager.GetRenderQuality();
        var qlabel = "High";
        if (qlevel === 1) qlabel = "Medium";
        else if (qlevel == 2) qlabel = "Low";
        BABYLON.Tools.Log("Graphics render quality: " + qlabel);
        BABYLON.SceneLoader.Load(root, name, engine, (newscene) => {
            window.scene = newscene;
            //window.scene.blockMaterialDirtyMechanism = true;
            window.scene.executeWhenReady(() => {
                loaded = true;
                // DEPRECTAED
                //if (window.scene.cameras == null || window.scene.cameras.length <= 0) {
                //    var camera = new TOOLKIT.UniversalCamera("DefaultCamera", new BABYLON.Vector3(0, 5, -10), window.scene);
                //    camera.setTarget(BABYLON.Vector3.Zero());
                //    camera.attachControl(divcvs, true);
                //    window.scene.activeCamera = camera;
                //    console.warn("Warning: Attached engine page default camera");
                //    if (window.scene.lights == null || window.scene.lights.length <= 0) {
                //        var light = new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0, 1, 0), window.scene);
                //        light.intensity = 1.0;
                //        console.warn("Warning: Attached engine page default light");
                //    }
                //    window.setTimeout(()=>{ window.hideSceneLoader(); }, 3000);
                //}
                engine.runRenderLoop(() => { 
                    if (TOOLKIT.SceneManager.RenderLoopReady === true && TOOLKIT.SceneManager.PauseRenderLoop === false && TOOLKIT.SceneManager.LostRenderContext === false) {
                        if (window.METER) {
                            window.METER.tickStart();
                            if (TOOLKIT.SceneManager.OnPreRenderLoopObservable.hasObservers() === true) {
                                TOOLKIT.SceneManager.OnPreRenderLoopObservable.notifyObservers();
                            }
                            window.scene.render();
                            if (TOOLKIT.SceneManager.OnPostRenderLoopObservable.hasObservers() === true) {
                                TOOLKIT.SceneManager.OnPostRenderLoopObservable.notifyObservers();
                            }
                            window.METER.tick();
                        } else {
                            if (TOOLKIT.SceneManager.OnPreRenderLoopObservable.hasObservers() === true) {
                                TOOLKIT.SceneManager.OnPreRenderLoopObservable.notifyObservers();
                            }
                            window.scene.render();
                            if (TOOLKIT.SceneManager.OnPostRenderLoopObservable.hasObservers() === true) {
                                TOOLKIT.SceneManager.OnPostRenderLoopObservable.notifyObservers();
                            }
                        }
                    }
                });
                window.resizeRenderingCanvas();
                // DEPRECIATED
                // if (autohide === true) {
                //    window.setTimeout(()=>{ // Note: Fallback Hide Scene Loader Handler
                //        var hideSceneLoaderHandled = (window.scene != null && window.scene.metadata != null && window.scene.metadata.toolkit != null && window.scene.metadata.toolkit.hideloader != null && window.scene.metadata.toolkit.hideloader === true);
                //        if (hideSceneLoaderHandled === false) {
                //            if (divcvs.style.opacity !== "1") {
                //                window.hideSceneLoader();
                //                console.warn("FALLBACK: Hide Scene Loader Timeout: 5000ms");
                //            }
                //        }
                //    }, 5000); 
                // }
            });
        }, (evt) => {
            window.handleLoadProgress(evt);
        }, (scene, message, exception) => {
            window.showErrorMessage(exception || message || ("Unknown error loading scene:" + name));
        });
    };
    window.loadSceneFile = () => {
        loaded = false;
        window.scene = null;
        window.showSceneLoader();
        window.executeSceneLoader(scenepath, scenename);
    };
    window.defaultSceneLoader = () => {
        try {
            window.loadSceneFile();
        } catch (ex2) {
            window.showErrorMessage(ex2.message || "Unknown Scene Exception");
        }
    };
    window.recastDetourLoader = () => {
        try {
            if (typeof Recast !== "undefined") {
                Recast().then((recast) => {
                    globalThis.RECAST = recast;
                    defaultSceneLoader();
                });
            } else {
                window.defaultSceneLoader();
            }
        } catch (ex3) {
            window.showErrorMessage(ex3.message || "Unknown Recast Exception");
        }
    };
    window.havokPhysicsLoader = () => {
        try {
            if (typeof HavokPhysics !== "undefined") {
                HavokPhysics().then((havok) => {
                    globalThis.HK = havok;
                    recastDetourLoader();
                });
            } else {
                window.recastDetourLoader();
            }
        } catch (ex4) {
            window.showErrorMessage(ex4.message || "Unknown Havok Exception");
        }
    };
    window.startSceneLoader = () => {
        // TODO: STANDALONE REQUIRED - Show the standalone warning cover as new splash screen with open anyways link that flips back to splash screen and starts the loader as normal by calling window.havokPhysicsLoader()
        // TODO: STANDALONE REQUIRED - var standalone_warning = document.getElementById("standalone-warning");
        // TODO: STANDALONE REQUIRED - if (standalone_warning != null) standalone_warning.style.display = "flex";
        // TODO: STANDALONE REQUIRED - if (splash != null) splash.className = "hidden";
        // ..
        // TODO: STANDALONE NOT REQUIRED - Load scene file as normal
        window.havokPhysicsLoader();
    };
    // ************************************************************************ //
    // RENDER CANVAS - Engine Reseize Observer Notification                     //
    // ************************************************************************ //
    window.checkOrientation = () => {
        // if (window.screen.orientation != null) {
        //     var orientation = window.screen.orientation.type;
        //     if (orientation === "landscape-primary" || orientation === "landscape-secondary") {
        //         document.getElementById("portrait-warning").style.display = "none";
        //         document.getElementById("landscape-warning").style.display = "none";
        //     } else {
        //         document.getElementById("portrait-warning").style.display = "block";
        //         document.getElementById("landscape-warning").style.display = "none";
        //     }
        // }
    };
    window.resizeRenderingCanvas = (forceSizing) => {
        if (engine != null) engine.resize(forceSizing);
        if (TOOLKIT.SceneManager.OnEngineResizeObservable.hasObservers() === true) {
            TOOLKIT.SceneManager.OnEngineResizeObservable.notifyObservers(engine);
        }
    };
    window.addEventListener("resize", () => { window.resizeRenderingCanvas(); });
    window.addEventListener("orientationchange", () => { window.checkOrientation(); });
    // ************************************************************************ //
    // BABYLON ENGINE - Create Engine And Load Project Scene Hiearchy           //
    // ************************************************************************ //
    window.setupBabylonEngineHostPage = () => {
        try {
            var useStencilBuffer = stencil;
            var preserveDrawBuffer = (preserve > 0);
            if (renderengine === 1) {
                if (navigator.gpu) {
                    engine = new BABYLON.WebGPUEngine(divcvs, { powerPreference: "default", doNotHandleContextLost: true });
                    engine.initAsync({ jsPath: "###SCRIPT###/glslang.js", wasmPath: "###SCRIPT###/glslang.wasm" }).catch((ex) => { showErrorMessage(ex.message || "Unknown WebGPU Exception"); }).then(() => {
                        BABYLON.Tools.Log("WebGPU rendering engine enabled");
                        window.prepareBabylonEngineProperties();
                    });
                } else {
                    BABYLON.Tools.Warn("WebGPU is not supported on platform. Falling back to WebGL");
                    engine = new BABYLON.Engine(divcvs, antialias, { powerPreference: "default", preserveDrawingBuffer: preserveDrawBuffer, stencil: useStencilBuffer, premultipliedAlpha: false, doNotHandleContextLost: true }, false);
                    window.prepareBabylonEngineProperties();
                }
            } else {
                engine = new BABYLON.Engine(divcvs, antialias, { powerPreference: "default", preserveDrawingBuffer: preserveDrawBuffer, stencil: useStencilBuffer, premultipliedAlpha: false, doNotHandleContextLost: true }, false);
                window.prepareBabylonEngineProperties();
            }
        } catch (ex3) {
            window.showErrorMessage(ex3.message || "Unknown Engine Exception");
        }
    };
    window.prepareBabylonEngineProperties = () => {
        // ************************************************************************ //
        window.audioEngineClicked = false;    
        window.doAudioEngineClick = () => {
            if (window.audioEngineClicked === false) {
                if (BABYLON.Engine && BABYLON.Engine.audioEngine && BABYLON.Engine.audioEngine.unlock) {
                    window.audioEngineClicked = true;
                    try { BABYLON.Engine.audioEngine.unlock(); } catch {}
                    document.removeEventListener("click", window.doAudioEngineClick);
                }
            }
        }
        document.addEventListener("click", window.doAudioEngineClick);
        // ************************************************************************ //
        engine.loadingScreen = new LoadingScreen();
        engine.enableOfflineSupport = offline;
        // DEPRECIATED: engine.renderEvenInBackground = renderinbackground;
        // DEPRECIATED: engine.clear(new BABYLON.Color3(0, 0, 0), true, true, true);
        engine.displayLoadingUI();
        // ************************************************************************ //
        // if (handlecontext === true) {
        //     engine.onContextLostObservable.add(()=>{
        //         TOOLKIT.SceneManager.LostRenderContext = true;
        //         console.warn(">>> Render context lost. Pausing render loop.");
        //     });
        //     engine.onContextRestoredObservable.add(()=>{
        //         if (TOOLKIT.SceneManager.OnRebuildContextObservable.hasObservers() === true) {
        //             TOOLKIT.SceneManager.OnRebuildContextObservable.notifyObservers(engine);
        //         }
        //         TOOLKIT.SceneManager.LostRenderContext = false;
        //         console.warn(">>> Render context resored. Unpaused render loop.");
        //     });
        // }
        // ************************************************************************ //
        // Manually Adapt To Device Ratio (Supports Safari)                         //
        // ************************************************************************ //
        if (adaptive === true) {
            var hardwareScaling = (1.0 / window.devicePixelRatio);
            engine.setHardwareScalingLevel(hardwareScaling);
        }
        // ************************************************************************ //
        // KTX2 DECODER - Initialize Default Loader Locations                       //
        // ************************************************************************ //
        if (BABYLON.KhronosTextureContainer2 && BABYLON.KhronosTextureContainer2.URLConfig) {
            var href = window.location.href;
            var path = href.substring(0, href.lastIndexOf('/')) + "/";
            BABYLON.KhronosTextureContainer2.URLConfig.jsDecoderModule = path + "###SCRIPT###/babylon.ktx2Decoder.js";
            BABYLON.KhronosTextureContainer2.URLConfig.jsMSCTranscoder = path + "###SCRIPT###/msc_basis_transcoder.js";
            BABYLON.KhronosTextureContainer2.URLConfig.wasmMSCTranscoder = path + "###SCRIPT###/msc_basis_transcoder.wasm";
            BABYLON.KhronosTextureContainer2.URLConfig.wasmZSTDDecoder = path + "###SCRIPT###/zstddec.wasm";
            BABYLON.KhronosTextureContainer2.URLConfig.wasmUASTCToASTC = path + "###SCRIPT###/uastc_astc.wasm";
            BABYLON.KhronosTextureContainer2.URLConfig.wasmUASTCToBC7 = path + "###SCRIPT###/uastc_bc7.wasm";
            BABYLON.KhronosTextureContainer2.URLConfig.wasmUASTCToRGBA_UNORM = path + "###SCRIPT###/uastc_rgba32_unorm.wasm";
            BABYLON.KhronosTextureContainer2.URLConfig.wasmUASTCToRGBA_SRGB = path + "###SCRIPT###/uastc_rgba32_srgb.wasm";
            BABYLON.KhronosTextureContainer2.URLConfig.wasmUASTCToR8_UNORM = path + "###SCRIPT###/uastc_r8_unorm.wasm";
            BABYLON.KhronosTextureContainer2.URLConfig.wasmUASTCToRG8_UNORM = path + "###SCRIPT###/uastc_rg8_unorm.wasm";
        }
        if (window.useServiceWorker === true) {
            window.autoStartLoader = true; // Note: Allow Service Worker To Start The Scene Loader After Page Is Fully Loaded
            window.updateStatus("PLEASE WAIT", "STARTING SERVICE", 0);
        } else {
            window.startSceneLoader();
        }
    };
    // ************************************************************************ //
    // PAGE VISIBLE - Pause Render Loop When Not Visible                        //
    // ************************************************************************ //
    document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === 'visible') {
            //console.log(">>> PAGE IS VISIBLE: " + document.visibilityState);
        } else {
            //console.lowarng(">>> PAGE IS NOT VISIBLE: " + document.visibilityState);
        }
    });
    // ************************************************************************ //
    // DEFAULT LOADER - Initialize Default Scene Loading                        //
    // ************************************************************************ //
    window.onload = () => {
        window.checkOrientation();
        if (scenename != null && scenename !== "") {
            window.setupBabylonEngineHostPage();
        }
    };
    </script>
</body>
</html>
